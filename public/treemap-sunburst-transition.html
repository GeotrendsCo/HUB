<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treemap to Sunburst Transition</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        #logo-container {
            text-align: center;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        #bottom-logos {
            position: absolute;
            right: 10px;
            bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        #bottom-logos img {
            margin: 5px 0;
        }

        #chart {
            width: 100vw;
            height: 90vh;
            z-index: 1;
        }

        #toggleButton {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
        }
    </style>
</head>
<body>

    <!-- Botón para cambiar entre Treemap y Sunburst -->
    <button id="toggleButton" class="btn btn-primary">Cambiar Gráfico</button>

    <!-- Contenedor para el logo superior centrado -->
    <!-- <div id="logo-container">
        <img src="static/logo-usbmed.png" alt="Logo USBMed" width="200">
    </div> -->

    <!-- Gráfico -->
    <div id="chart"></div>

    <!-- Contenedor para los logos en la parte inferior derecha -->
    <!-- <div id="bottom-logos">
        <img src="static/HUB.jpeg" alt="HUB Logo" width="150">
        <img src="static/INGENIERÍAS NEGRO.png" alt="Ingenierías Logo" width="150">
    </div> -->

    <script>
        var chartDom = document.getElementById('chart');
        var myChart = echarts.init(chartDom);
        var option;

        var currentChartType = 'treemap';

        // Función para generar colores basados en el producto padre
        function getColorByProductPadre(index, depth) {
            var colors = [
                ['#5470c6', '#6e8ad6', '#8aa2e5'], // Colores para el primer producto padre
                ['#91cc75', '#a9db91', '#c3e8ac'], // Colores para el segundo producto padre
                ['#fac858', '#fad078', '#fbe089'], // Colores para el tercer producto padre
                ['#ee6666', '#f08989', '#f3aaaa'], // Colores para el cuarto producto padre
                ['#73c0de', '#8bcee9', '#a5dcf2']  // Colores para el quinto producto padre
            ];
            return colors[index % colors.length][depth % 3];
        }

        // Función para asignar colores recursivamente según el producto padre
        function assignColors(data, depth = 0, parentIndex = 0) {
            data.forEach((item, index) => {
                item.itemStyle = { color: getColorByProductPadre(parentIndex, depth) };
                
                // Para productos padres
                if (depth === 0) {
                    item.label = {
                        show: true,
                        backgroundColor: getColorByProductPadre(parentIndex, depth), // Fondo para el producto padre
                        color: '#fff',  // Texto en blanco
                        borderRadius: 5,
                        padding: [5, 10],
                        fontWeight: 'bold'  // Negrita para productos padres
                    };
                }

                // Para proyectos estratégicos
                if (depth === 1) {
                    item.label = {
                        show: true,
                        backgroundColor: getColorByProductPadre(parentIndex, depth), // Fondo para proyectos estratégicos
                        color: '#000',  // Texto en negro
                        borderRadius: 3,
                        padding: [3, 7],
                        fontWeight: 'bold'  // Negrita para proyectos estratégicos
                    };
                }

                if (item.children) {
                    assignColors(item.children, depth + 1, parentIndex);
                }
            });
        }

        // Función para dividir el texto largo sin cortar palabras
        function formatLabelText(name) {
            var maxCharsPerLine = 12;  // Máximo número de caracteres por línea
            var words = name.split(' ');  // Dividir el texto en palabras
            var result = '';
            var line = '';

            words.forEach(function (word) {
                if ((line + word).length > maxCharsPerLine) {
                    result += line + '\n';  // Añadir salto de línea si excede el máximo de caracteres por línea
                    line = word + ' ';  // Iniciar nueva línea con la palabra actual
                } else {
                    line += word + ' ';  // Agregar palabra a la línea actual
                }
            });

            result += line.trim();  // Añadir la última línea

            return result.trim();  // Eliminar espacios innecesarios
        }

        fetch('/data/sunburst_data.json')
            .then(response => response.json())
            .then(data => {
                // Asignar colores por producto padre
                data.children.forEach((productPadre, index) => {
                    assignColors([productPadre], 0, index);
                });

                var treemapOption = {
                    series: [
                        {
                            type: 'treemap',
                            data: data.children,
                            label: {
                                show: true,
                                formatter: '{b}'
                            },
                            upperLabel: {
                                show: true,
                                fontWeight: 'bold'  // Negrita solo para Treemap
                            },
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            },
                            breadcrumb: {
                                show: true
                            }
                        }
                    ]
                };

                var sunburstOption = {
                    series: [
                        {
                            type: 'sunburst',
                            data: data.children,
                            radius: ['20%', '90%'],
                            label: {
                                rotate: 'radial',
                                formatter: function(params) {
                                    return formatLabelText(params.data.name);
                                },
                                overflow: 'break',  // Para permitir que el texto se ajuste
                                align: 'center',
                                fontSize: 8
                            },
                            emphasis: {
                                focus: 'ancestor'
                            },
                            levels: [
                                {},
                                {
                                    r0: '20%',
                                    r: '40%',
                                    itemStyle: {
                                        borderWidth: 2
                                    },
                                    label: {
                                        rotate: 'tangential',
                                        fontSize: 8
                                    }
                                },
                                {
                                    r0: '40%',
                                    r: '90%',
                                    label: {
                                        align: 'right',
                                        fontSize: 8
                                    }
                                },
                                {
                                    r0: '90%',
                                    r: '100%',
                                    label: {
                                        position: 'outside',
                                        padding: 3,
                                        silent: false,
                                        fontSize: 8
                                    },
                                    itemStyle: {
                                        borderWidth: 3
                                    }
                                }
                            ]
                        }
                    ]
                };

                option = treemapOption;
                myChart.setOption(option);

                document.getElementById('toggleButton').addEventListener('click', function () {
                    if (currentChartType === 'treemap') {
                        currentChartType = 'sunburst';
                        myChart.setOption(sunburstOption);
                        document.getElementById('toggleButton').textContent = "Cambiar a TreeMap";
                    } else {
                        currentChartType = 'treemap';
                        myChart.setOption(treemapOption);
                        document.getElementById('toggleButton').textContent = "Cambiar a Sunburst";
                    }
                });
            });
    </script>
</body>
</html>
